name: Test Coverage Reusable

on:
  workflow_call:
    inputs:
      modules:
        required: true
        type: string
      go-version:
        required: true
        type: string
      gist-id:
        required: true
        type: string
    secrets:
      GIST_SECRET:
        required: true

jobs:
  coverage:
    name: Run tests and update badge
    runs-on: ubuntu-latest

    env:
      COVERAGE_DIR: coverage
      COVERAGE_FILE: total.out

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4.2.2

      - name: ğŸ§° Set up Go
        uses: actions/setup-go@v5.4.0
        with:
          go-version: ${{ inputs.go-version }}

      - name: ğŸ“Œ Install Task
        uses: arduino/setup-task@v2.0.0

      - name: ğŸ§ª Run tests with coverage
        env:
          MODULES: ${{ inputs.modules }}
        run: task test-coverage

      - name: ğŸ“Š Extract coverage percent
        id: coverage_percent
        run: |
          # Ğ’Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ÑÑ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ñ total Ğ¸ Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ‚Ğ°Ğ±Ñ‹ Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ñ‹
          COVERAGE_OUTPUT=$(go tool cover -func=${COVERAGE_DIR}/${COVERAGE_FILE} | tail -1)
          echo "Raw coverage output: $COVERAGE_OUTPUT"

          # ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ²Ñ‹Ğ²Ğ¾Ğ´, Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ Ñ‚Ğ°Ğ±Ñ‹ Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ñ‹ Ğ¸ Ğ»Ğ¸ÑˆĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ñ‹ ÑÑ…Ğ»Ğ¾Ğ¿Ñ‹Ğ²Ğ°ĞµĞ¼
          CLEAN_OUTPUT=$(echo "$COVERAGE_OUTPUT" | tr -s '\t ' ' ')
          echo "Cleaned output: $CLEAN_OUTPUT"

          # Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ - ÑÑ‚Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚
          TOTAL=$(echo "$CLEAN_OUTPUT" | awk '{print $NF}')
          echo "ğŸ’¯ Total coverage: $TOTAL"

          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑˆĞ°Ğ³Ğ°
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ Update Gist Badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: ${{ inputs.gist-id }}
          filename: coverage.json
          label: Coverage
          message: ${{ steps.coverage_percent.outputs.total }}
          color: green
